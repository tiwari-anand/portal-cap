const COMMON_FIELD_CONTROL = '@Common.FieldControl'

const isAssociationOrComposition = element => element.type === 'cds.Association' || element.type === 'cds.Composition'

const isMandatoryField = element => {
  // this is not a public annotation!
  if (element['@assert.mandatory'] === false) return false
  return (
    ((element[COMMON_FIELD_CONTROL] && element[COMMON_FIELD_CONTROL]['#'] === 'Mandatory') ||
      element['@Common.FieldControl.Mandatory'] ||
      element['@FieldControl.Mandatory'] ||
      element['@mandatory']) &&
    !isAssociationOrComposition(element)
  )
}

const isReadOnlyFieldControl = element => {
  return (
    (element[COMMON_FIELD_CONTROL] && element[COMMON_FIELD_CONTROL]['#'] === 'ReadOnly') ||
    element['@Common.FieldControl.ReadOnly'] ||
    element['@FieldControl.ReadOnly'] ||
    element['@readonly']
  )
}

const isComputedReadOnly = element => {
  return element['@Core.Computed']
}

const isOnUpdateOrInsert = element => {
  return element['@cds.on.update'] || element['@cds.on.insert']
}

const isReadOnlyField = element => {
  return (
    element &&
    // keys are intentionally added to data to build queries later on -> not read only for us
    !element.key &&
    (isReadOnlyFieldControl(element) ||
      isComputedReadOnly(element) ||
      isOnUpdateOrInsert(element) ||
      element['virtual'])
  )
}

module.exports = {
  isAssociationOrComposition,
  isMandatoryField,
  isReadOnlyFieldControl,
  isComputedReadOnly,
  isOnUpdateOrInsert,
  isReadOnlyField
}
