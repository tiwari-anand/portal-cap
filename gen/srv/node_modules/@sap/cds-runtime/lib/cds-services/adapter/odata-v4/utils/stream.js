const cds = global.cds || require('@sap/cds/lib')
const { SELECT } = cds.ql
const { adaptStreamCQN } = require('../../../services/utils/draftUtils')
const cqn2cqn4sql = require('../../../../common/utils/cqn2cqn4sql')
const isStreaming = segments => {
  const lastSegment = segments[segments.length - 1]
  return (
    segments.length > 1 &&
    lastSegment.getKind() === 'PRIMITIVE.PROPERTY' &&
    lastSegment
      .getProperty()
      .getType()
      .getName() === 'Stream'
  )
}

const _getType = async (property, req) => {
  // REVISIT DRAFT HANDLING: cqn2cqn4sql should not happen here, but adaptStreamCQN relies on exists clause
  const cqn = cqn2cqn4sql(SELECT.from(req.query.SELECT.from)).columns([property])

  adaptStreamCQN(cqn)

  try {
    const res = await cds.tx(req).run(cqn)
    return res.length !== 0 ? res[0][property] : undefined
  } catch (e) {
    // REVISIT: why ignore?
  }
}

const getContentType = (segments, srv, req) => {
  // REVISIT: we need to read direcly from db, which might not be there!
  if (!cds.db) return Promise.resolve()

  const definitions = srv.model.definitions
  const propertyName = segments[segments.length - 1].getProperty().getName()

  let propertyType
  if (segments[segments.length - 2].getKind() === 'ENTITY') {
    const entityName = segments[segments.length - 2].getEntitySet().getName()
    const entityDefinition = definitions[`${srv.name}.${entityName}`]
    // REVISIT: rm target['@cds.persistence.skip'] !== 'if-unused' with cds^4.5
    if (entityDefinition['@cds.persistence.skip'] && entityDefinition['@cds.persistence.skip'] !== 'if-unused') {
      return Promise.resolve()
    }

    propertyType = entityDefinition.elements[`${propertyName}`]['@Core.MediaType']
    if (typeof propertyType === 'object') return _getType(Object.values(propertyType)[0], req)
  }

  return Promise.resolve(propertyType)
}

module.exports = {
  isStreaming,
  getContentType
}
