const cds = global.cds || require('@sap/cds/lib')

const { uri: { UriResource: { ResourceKind: { BOUND_ACTION, BOUND_FUNCTION } } } } = require('./okra/odata-server')

const MODEL = Symbol.for('sap.cds.model')
const { COMMON, ODATA } = require('../../../common/constants/annotation')

const odataToCQN = require('./odata-to-cqn')
const { getData, getParams } = require('./utils/data')
const { flattenDeepToOneAssociations } = require('../../services/utils/handlerUtils')

function _isCorrectCallToViewWithParams (csdlStructuredType) {
  return csdlStructuredType.navigationProperties &&
    csdlStructuredType.navigationProperties[0] &&
    csdlStructuredType.navigationProperties[0].name === 'Parameters' &&
    csdlStructuredType.navigationProperties[0].partner === 'Set'
}

function _getTarget (entities, segments) {
  let last = segments.pop()
  if (!last) return
  if (last.getKind() === BOUND_FUNCTION || last.getKind() === BOUND_ACTION) {
    last = segments.pop()
  }

  if (last.getEdmType() && last.getEdmType().csdlStructuredType) {
    // REVISIT: better way to identify situation "view with parameters"
    const name = _isCorrectCallToViewWithParams(last.getEdmType().csdlStructuredType)
      ? last.getEdmType().csdlStructuredType.navigationProperties[0].type.name
      : last.getEdmType().csdlStructuredType.name

    const t = entities[name] || (name.endsWith('Parameters') && entities[name.replace(/Parameters$/, '')])
    if (t) return t
  }

  return _getTarget(entities, segments)
}

function _isDraftEntity (target) {
  return target && (target[ODATA.DRAFT] || target[COMMON.DRAFT_NODE.PREP_ACTION])
}

/*
 * Class representing an OData request.
 * @extends Request
 *
 * @param {String} type - The OData request type (a.k.a. "Component")
 * @param {Object} service - The underlying CAP service
 * @param {Object} odataReq - OKRA's req
 * @param {Object} odataRes - OKRA's res
 */
class ODataRequest extends cds.Request {
  constructor (type, service, odataReq, odataRes, upsert) { // NOSONAR
    const _ = {
      req: odataReq.getBatchApplicationData() ? odataReq.getBatchApplicationData().req : odataReq.getIncomingRequest()
    }
    _.res = _.req.res

    /*
     * target
     */
    let target = _getTarget(service.entities, [...odataReq.getUriInfo().getPathSegments()])

    /*
     * data
     */
    const data = getData(type, odataReq, service)

    /*
     * query
     */
    // REVISIT: remove usage of req._.returnType
    let operation = odataReq.getUriInfo().getLastSegment() && odataReq.getUriInfo().getLastSegment().getKind()
    switch (operation) {
      case 'BOUND.ACTION':
      case 'ACTION.IMPORT':
      case 'BOUND.FUNCTION':
      case 'FUNCTION.IMPORT':
        _.returnType = target
        break
      default:
        operation = type
    }
    if (operation.endsWith('.IMPORT')) {
      target = undefined
    }
    const query = odataToCQN(operation, service, target, data, odataReq, upsert)

    /*
     * event
     */
    let event = type
    // actions & functions
    switch (odataReq.getUriInfo().getLastSegment() && odataReq.getUriInfo().getLastSegment().getKind()) {
      case 'BOUND.ACTION':
        event = odataReq.getUriInfo().getLastSegment().getAction().getName()
        break
      case 'ACTION.IMPORT':
        event = odataReq.getUriInfo().getLastSegment().getActionImport().getName()
        break
      case 'BOUND.FUNCTION':
        event = odataReq.getUriInfo().getLastSegment().getFunction().getName()
        break
      case 'FUNCTION.IMPORT':
        event = odataReq.getUriInfo().getLastSegment().getFunctionImport().getName()
        break
      default:
      // nothing to do
    }
    // draft
    if (_isDraftEntity(target)) {
      if (type === 'CREATE') event = 'NEW'
      else if (event === 'draftEdit') event = 'EDIT'
      else if (type === 'UPDATE') event = 'PATCH'
      else if (type === 'DELETE' && data.IsActiveEntity !== 'true') event = 'CANCEL'
    }

    /*
     * user
     */
    const user = _.req.user || Object.defineProperty(new cds.User(), '_req', { enumerable: false, value: _.req })

    /*
     * method, headers
     */
    const method = odataReq.getMethod()
    // REVISIT: 'x-cds-incoming-protocol' workaround to find out in outgoing rest/messaging if custom headers were provided
    _.req.headers['x-cds-incoming-protocol'] = 'odata'
    const headers = Object.assign({}, _.req.headers, odataReq.getHeaders())

    /*
     * super
     */
    // REVISIT: _model should not be necessary
    super({ event, target, data, query, user, method, headers, _, _model: service.model })

    // REVISIT: validate associations for deep insert
    flattenDeepToOneAssociations(this, this.model)

    /*
     * req.run
     */
    Object.defineProperty(this, 'run', {
      configurable: true,
      get: () => (...args) => {
        // REVISIT: no console
        // console.warn('[cds] req.run is deprecated and will be removed')
        return cds.tx(this).run(...args)
      }
    })

    /*
     * req.params
     */
    Object.defineProperty(this, 'params', {
      configurable: true,
      get: function () {
        this._params = this._params || getParams(odataReq)
        return this._params
      }
    })

    // REVISIT: streamline ref to model
    this[MODEL] = service.model

    /*
     * REVISIT: compat req._.*
     */
    // odataReq and odataRes
    this._.odataReq = odataReq
    this._.odataRes = odataRes
    // req._.shared
    const that = this
    Object.defineProperty(this._, 'shared', {
      get () {
        if (!cds._deprecationWarningForShared) {
          // REVISIT: no console
          console.warn('[cds] req._.shared is deprecated and will be removed')
          cds._deprecationWarningForShared = true
        }

        if (that.context) {
          that._shared = that.context._shared = that.context._shared || { req: _.req, res: _.res }
        } else {
          that._shared = that._shared || { req: _.req, res: _.res }
        }
        return that._shared
      }
    })
    // req.attr
    const attr = { identityZone: this.user.tenant }
    Object.defineProperty(this, 'attr', {
      get () {
        if (!cds._deprecationWarningForAttr) {
          // REVISIT: no console
          console.warn('[cds] req.attr is deprecated and will be removed')
          cds._deprecationWarningForAttr = true
        }

        return attr
      }
    })

    if (this._.req.performanceMeasurement) {
      this.performanceMeasurement = this._.req.performanceMeasurement
    }
    if (this._.req.dynatrace) {
      this.dynatrace = this._.req.dynatrace
    }
  }
}

module.exports = ODataRequest
