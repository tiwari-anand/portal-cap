const cds = global.cds || require('@sap/cds/lib')
const { SELECT } = cds.ql
const cqn2cqn4sql = require('../../common/utils/cqn2cqn4sql')

/*
 * before delete
 */
const _isPrimitiveKey = e => !e.is2one && !e.is2many

async function beforeDelete (req) {
  // REVISIT: temp private for AFC
  if (cds.env.runtime && cds.env.runtime.skipIntegrity) {
    return
  }

  if (!this.model || typeof req.query === 'string' || !req.target || req.target._unresolved) {
    return
  }

  if (Object.keys(req.data).length > 0) {
    // via protocol adapter with key predicates
    return
  }

  const target = this.model.definitions[req.target.name]
  if (!target) {
    return
  }

  // REVISIT: only if target is parent
  const keys = Object.keys(target.keys).filter(k => _isPrimitiveKey(target.elements[k]))
  let select = SELECT(keys).from(req.target.name)
  if (req.query.DELETE.where) {
    select = select.where(req.query.DELETE.where)
  }

  select = cqn2cqn4sql(select, this.model)

  req._beforeDeleteData = await this._read(this.model, this.dbc, select, req.context || req)
}

beforeDelete._initial = true

/*
 * perform check
 */
const { checkIntegrityUtil } = require('../../cds-services/services/utils/handlerUtils')
const C_UD = { CREATE: 1, UPDATE: 1, DELETE: 1 }

const _performCheck = async (req, cur, csn, run) => {
  const prev = (cur.errors && cur.errors.length) || 0

  await checkIntegrityUtil(cur, csn, run)

  // only additional errors
  if (cur.errors && cur.errors.length > prev) {
    req.errors = req.errors ? [...req.errors, ...cur.errors] : cur.errors
  }
}

function performCheck (req) {
  // REVISIT: temp private for AFC
  if (cds.env.runtime && cds.env.runtime.skipIntegrity) {
    return
  }

  const root = req.context || req
  const children = root._children
  if (!children || !(this.name in children)) return

  const relevant = children[this.name].filter(r => r.event in C_UD)
  if (relevant.length === 0) return

  return Promise.all(
    relevant.map(r => _performCheck(req, r, this.model, query => this._read(this.model, this.dbc, query, root)))
  )
}

performCheck._initial = true

module.exports = {
  beforeDelete,
  performCheck
}
